<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>La Playita - Control de Ingreso y Salida</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="../css/dashboard.css" rel="stylesheet">
    <style>
        body { font-family: 'Poppins', sans-serif; }
        .card { border: none; box-shadow: 0 0 15px rgba(0,0,0,.05); }
        .receipt { font-size: .95rem; }
        .receipt h6 { font-weight: 600; }
        .print-area { background: #fff; }
        @media print { .no-print { display: none !important; } .print-area { box-shadow: none !important; } }
    </style>
    <script>
        if (!localStorage.getItem('token')) { window.location.href = '/'; }
    </script>
</head>
<body>
    <div class="sidebar">
        <div class="sidebar-header">
            <div class="logo-container"><div class="logo-circle"><img src="../playita.png" alt="La Playita"></div></div>
            <h5 class="mt-3 text-white">La Playita</h5>
        </div>
        <nav class="sidebar-nav">
            <ul class="nav flex-column">
                <li class="nav-item"><a href="dashboard.html" class="nav-link"><i class="fas fa-tachometer-alt"></i><span>Dashboard</span></a></li>
                <li class="nav-item"><a href="vehiculos.html" class="nav-link"><i class="fas fa-car"></i><span>Vehículos</span></a></li>
                <li class="nav-item"><a href="ingreso-salida.html" class="nav-link active"><i class="fas fa-right-left"></i><span>Ingreso / Salida</span></a></li>
                <li class="nav-item admin-only"><a href="configuracion.html" class="nav-link"><i class="fas fa-gear"></i><span>Configuración</span></a></li>
            </ul>
        </nav>
        <div class="sidebar-footer"><a href="#" class="nav-link" id="btnLogout"><i class="fas fa-sign-out-alt"></i><span>Cerrar Sesión</span></a></div>
    </div>

    <div class="main-content">
        <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
            <div class="container-fluid">
                <button class="btn btn-link sidebar-toggle"><i class="fas fa-bars"></i></button>
                <div class="navbar-collapse"><ul class="navbar-nav ms-auto"><li class="nav-item"><span class="nav-link"><i class="fas fa-user-circle me-2"></i><span id="userName">Usuario</span></span></li></ul></div>
            </div>
        </nav>

        <div class="container-fluid py-4">
            <div class="row g-4">
                <!-- Ingreso -->
                <div class="col-12 col-lg-6" id="seccionIngreso">
                    <div class="card">
                        <div class="card-header bg-white d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="fas fa-right-to-bracket me-2 text-success"></i>Ingreso rápido</h5>
                            <button class="btn btn-outline-secondary btn-sm" onclick="window.location.href='dashboard.html'">
                                <i class="fas fa-arrow-left me-1"></i>Volver
                            </button>
                        </div>
                        <div class="card-body">
                            <form id="formIngreso" class="row g-3">
                                <div class="col-md-5">
                                    <label class="form-label">Placa</label>
                                    <input type="text" id="ingPlaca" class="form-control" placeholder="ABC123" required>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Tipo</label>
                                    <select id="ingTipo" class="form-select" required>
                                        <option value="">Seleccione</option>
                                        <option value="auto">Auto</option>
                                        <option value="camioneta">Camioneta</option>
                                        <option value="moto">Moto</option>
                                    </select>
                                </div>
                                <div class="col-md-3 d-flex align-items-end">
                                    <button class="btn btn-success w-100" type="submit"><i class="fas fa-play me-2"></i>Ingresar</button>
                                </div>
                            </form>
                            <div id="compIngreso" class="mt-4 d-none print-area">
                                <h6>Comprobante de Ingreso</h6>
                                <div class="receipt" id="compIngresoBody"></div>
                                <div class="no-print mt-2 d-flex gap-2">
                                    <button class="btn btn-outline-secondary btn-sm" id="btnPrintIngreso58"><i class="fas fa-print me-1"></i>Imprimir 58mm</button>
                                    <button class="btn btn-outline-secondary btn-sm" id="btnPrintIngreso80"><i class="fas fa-print me-1"></i>Imprimir 80mm</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Salida -->
                <div class="col-12 col-lg-6" id="seccionSalida">
                    <div class="card">
                        <div class="card-header bg-white d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="fas fa-right-from-bracket me-2 text-danger"></i>Salida y cobro</h5>
                            <button class="btn btn-outline-secondary btn-sm" onclick="window.location.href='dashboard.html'">
                                <i class="fas fa-arrow-left me-1"></i>Volver
                            </button>
                        </div>
                        <div class="card-body">
                            <!-- Lista de vehículos estacionados -->
                            <div id="vehiculosEstacionados" class="mb-4">
                                <h6 class="mb-3">Vehículos Estacionados</h6>
                                <div id="listaVehiculos" class="row g-2">
                                    <!-- Se carga dinámicamente -->
                                </div>
                                <div id="noVehiculos" class="text-center text-muted py-4 d-none">
                                    <i class="fas fa-car-side fa-2x mb-2"></i>
                                    <p>No hay vehículos estacionados actualmente</p>
                                </div>
                            </div>

                            <!-- Formulario de salida (se muestra al seleccionar un vehículo) -->
                            <div id="formSalidaContainer" class="d-none">
                                <hr>
                                <h6 class="mb-3">Registrar Salida</h6>
                                
                                <!-- Mostrar monto a pagar -->
                                <div id="montoAPagar" class="mb-3">
                                    <!-- Se llena dinámicamente -->
                                </div>
                                
                                <form id="formSalida" class="row g-3">
                                    <input type="hidden" id="salIdMovimiento">
                                    <div class="col-md-6">
                                        <label class="form-label">Vehículo Seleccionado</label>
                                        <input type="text" id="salVehiculoInfo" class="form-control" readonly>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Método de pago</label>
                                        <select id="salMetodo" class="form-select">
                                            <option value="efectivo">Efectivo</option>
                                            <option value="tarjeta">Tarjeta</option>
                                            <option value="QR">QR</option>
                                        </select>
                                    </div>
                                    <div class="col-12">
                                        <div class="d-flex gap-2">
                                            <button class="btn btn-danger" type="submit">
                                                <i class="fas fa-stop me-2"></i>Finalizar Salida
                                            </button>
                                            <button class="btn btn-outline-secondary" type="button" onclick="cancelarSeleccion()">
                                                <i class="fas fa-times me-2"></i>Cancelar
                                            </button>
                                        </div>
                                    </div>
                                </form>
                            </div>
                            <div id="compSalida" class="mt-4 d-none print-area">
                                <h6>Factura</h6>
                                <div class="receipt" id="compSalidaBody"></div>
                                <div class="no-print mt-2 d-flex gap-2">
                                    <button class="btn btn-outline-secondary btn-sm" id="btnPrintSalida58"><i class="fas fa-print me-1"></i>Imprimir 58mm</button>
                                    <button class="btn btn-outline-secondary btn-sm" id="btnPrintSalida80"><i class="fas fa-print me-1"></i>Imprimir 80mm</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Salida Exitosa -->
    <div class="modal fade" id="salidaExitosaModal" tabindex="-1" aria-labelledby="salidaExitosaModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title" id="salidaExitosaModalLabel">
                        <i class="fas fa-check-circle me-2"></i>¡Salida Registrada Exitosamente!
                    </h5>
                </div>
                <div class="modal-body text-center py-4">
                    <div class="mb-4">
                        <i class="fas fa-car text-success" style="font-size: 3rem;"></i>
                    </div>
                    <div id="resumenSalida">
                        <!-- Se llena dinámicamente -->
                    </div>
                </div>
                <div class="modal-footer justify-content-center">
                    <button type="button" class="btn btn-primary btn-lg px-4" onclick="volverAlDashboard()">
                        <i class="fas fa-home me-2"></i>Volver al Dashboard
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Pago -->
    <div class="modal fade" id="pagoModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Registrar Pago</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-2"><strong>Total:</strong> <span id="pagoTotal"></span></div>
                    <div class="mb-3">
                        <label class="form-label">Agregar medios de pago</label>
                        <div id="pagosContainer" class="d-flex flex-column gap-2"></div>
                        <button class="btn btn-outline-primary btn-sm mt-2" id="btnAddPago"><i class="fas fa-plus me-1"></i>Agregar pago</button>
                    </div>
                    <div class="alert alert-info py-2">
                        <div>Pagado: <strong id="pagoSum"></strong></div>
                        <div>Diferencia: <strong id="pagoDiff"></strong></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-success" id="btnConfirmPagos">Confirmar pagos</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Footer global (reutilizable). Relacionado con public/js/footer.js -->
    <script src="../js/footer.js"></script>
    <script src="../js/timezone-utils.js"></script>
    <script src="../js/ingreso-salida.js"></script>
    <script src="../js/turnos.js"></script>
    <script>
        const token = localStorage.getItem('token');
        let empresaInfo = null;
        let ultimoIngreso = null;
        let ultimaSalida = null;
        document.getElementById('userName').textContent = localStorage.getItem('userName') || 'Usuario';
        document.querySelector('.sidebar-toggle').addEventListener('click',()=>document.querySelector('.sidebar').classList.toggle('show'));
        document.getElementById('btnLogout').addEventListener('click',()=>{localStorage.clear(); location.href='/';});

        // Mostrar nombre y ocultar admin-only si no es admin
        (function(){
            const role = localStorage.getItem('userRole');
            if (role !== 'admin') {
                document.querySelectorAll('.admin-only').forEach(el=> el.classList.add('d-none'));
            }
        })();

        // Controlar qué sección mostrar según el parámetro de la URL
        (function(){
            const urlParams = new URLSearchParams(window.location.search);
            const action = urlParams.get('action');
            
            const seccionIngreso = document.getElementById('seccionIngreso');
            const seccionSalida = document.getElementById('seccionSalida');
            
            if (action === 'ingreso') {
                // Solo mostrar sección de ingreso
                seccionIngreso.classList.remove('col-lg-6');
                seccionIngreso.classList.add('col-lg-8', 'mx-auto');
                seccionSalida.style.display = 'none';
            } else if (action === 'salida') {
                // Solo mostrar sección de salida
                seccionSalida.classList.remove('col-lg-6');
                seccionSalida.classList.add('col-lg-8', 'mx-auto');
                seccionIngreso.style.display = 'none';
            }
            // Si no hay parámetro, mostrar ambas secciones (comportamiento por defecto)
        })();

        // Cargar info empresa para incluir en los comprobantes
        (async ()=>{
            try{
                const r = await fetch('/api/empresa/me',{headers:{'Authorization':`Bearer ${token}`}});
                const j = await r.json();
                if(r.ok){ empresaInfo = j.data; }
                // Cargar configuración (operacion_24h y horarios) para el ticket
                try{
                    const cr = await fetch('/api/empresa/config',{headers:{'Authorization':`Bearer ${token}`}});
                    const cj = await cr.json();
                    if (cr.ok && cj && cj.data){
                        empresaInfo.operacion_24h = cj.data.operacion_24h;
                        empresaInfo.horario_apertura = cj.data.horario_apertura;
                        empresaInfo.horario_cierre = cj.data.horario_cierre;
                    }
                }catch(e){}
                // Intentar cargar logo BLOB para mostrar en ticket
                try{
                    const lr = await fetch('/api/empresa/logo',{headers:{'Authorization':`Bearer ${token}`}});
                    if (lr.ok){
                        const blob = await lr.blob();
                        empresaInfo.logo_url = await new Promise((resolve)=>{
                            const fr = new FileReader();
                            fr.onload = ()=> resolve(fr.result);
                            fr.readAsDataURL(blob);
                        });
                    }
                }catch(e){}
            }catch(e){ console.warn('No se pudo cargar la empresa', e); }
        })();

        // Cargar vehículos estacionados al cargar la página
        cargarVehiculosEstacionados();

        // Función para cargar vehículos estacionados
        async function cargarVehiculosEstacionados() {
            try {
                const response = await fetch('/api/movimientos/activos', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (!response.ok) {
                    throw new Error('Error al cargar vehículos');
                }
                
                const data = await response.json();
                mostrarVehiculosEstacionados(data.data || []);
            } catch (error) {
                console.error('Error cargando vehículos:', error);
                document.getElementById('noVehiculos').classList.remove('d-none');
            }
        }

        // Función para obtener el color del tiempo según los minutos transcurridos
        function obtenerColorTiempo(minutos) {
            if (minutos < 60) {
                return { color: 'text-success', bg: 'bg-success-subtle', border: 'border-success' }; // Verde - menos de 1 hora
            } else if (minutos < 180) {
                return { color: 'text-primary', bg: 'bg-primary-subtle', border: 'border-primary' }; // Azul - 1-3 horas
            } else if (minutos < 480) {
                return { color: 'text-warning', bg: 'bg-warning-subtle', border: 'border-warning' }; // Amarillo - 3-8 horas
            } else {
                return { color: 'text-danger', bg: 'bg-danger-subtle', border: 'border-danger' }; // Rojo - más de 8 horas
            }
        }

        // Función para mostrar la lista de vehículos
        function mostrarVehiculosEstacionados(vehiculos) {
            const listaContainer = document.getElementById('listaVehiculos');
            const noVehiculosMsg = document.getElementById('noVehiculos');
            
            if (vehiculos.length === 0) {
                noVehiculosMsg.classList.remove('d-none');
                return;
            }
            
            noVehiculosMsg.classList.add('d-none');
            
            listaContainer.innerHTML = vehiculos.map(vehiculo => {
                const tiempoTranscurrido = calcularTiempoTranscurrido(vehiculo.minutos_transcurridos);
                const colorTiempo = obtenerColorTiempo(vehiculo.minutos_transcurridos);
                const montoEstimado = calcularMontoEstimado(vehiculo);
                
                return `
                    <div class="col-md-6 col-lg-4">
                        <div class="card ${colorTiempo.border} vehiculo-card shadow-sm" style="cursor: pointer; transition: all 0.2s;" 
                             onclick="seleccionarVehiculo(${vehiculo.id_movimiento}, '${vehiculo.placa}', '${vehiculo.tipo}', '${vehiculo.color}', '${vehiculo.modelo}', ${vehiculo.minutos_transcurridos}, ${montoEstimado})"
                             onmouseover="this.style.transform='translateY(-2px)'; this.classList.add('shadow')"
                             onmouseout="this.style.transform='translateY(0px)'; this.classList.remove('shadow')">
                            <div class="card-body p-3">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <h5 class="card-title mb-0 fw-bold text-dark">${vehiculo.placa}</h5>
                                    <span class="badge bg-secondary">${vehiculo.tipo}</span>
                                </div>
                                <div class="mb-2">
                                    <small class="text-muted">
                                        <i class="fas fa-palette me-1"></i>${vehiculo.color}
                                        ${vehiculo.modelo ? ` • ${vehiculo.modelo}` : ''}
                                    </small>
                                </div>
                                <div class="mb-2">
                                    <small class="text-muted">
                                        <i class="fas fa-clock me-1"></i>${formatArgentinaDate(vehiculo.fecha_entrada)}
                                    </small>
                                </div>
                                <div class="d-flex justify-content-between align-items-center">
                                    <span class="badge ${colorTiempo.bg} ${colorTiempo.color} px-2 py-1">
                                        <i class="fas fa-stopwatch me-1"></i>${tiempoTranscurrido}
                                    </span>
                                    <span class="fw-bold text-success">
                                        $${montoEstimado.toLocaleString('es-AR')}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Función para calcular tiempo transcurrido
        function calcularTiempoTranscurrido(minutos) {
            const dias = Math.floor(minutos / (24 * 60));
            const horas = Math.floor((minutos % (24 * 60)) / 60);
            const mins = minutos % 60;
            
            let resultado = '';
            if (dias > 0) resultado += `${dias}d `;
            if (horas > 0) resultado += `${horas}h `;
            resultado += `${mins}m`;
            
            return resultado;
        }

        // Función para calcular monto estimado
        function calcularMontoEstimado(vehiculo) {
            const minutos = vehiculo.minutos_transcurridos;
            const valorMinuto = vehiculo.valor_minuto || 0;
            const valorHora = vehiculo.valor_hora || 0;
            const valorDia = vehiculo.valor_dia_completo || 0;
            
            // Cálculo mixto/escalonado básico
            if (minutos < 60) {
                // Menos de 1 hora - cobrar por minutos
                return Math.ceil(minutos * valorMinuto);
            } else if (minutos < 1440) { // Menos de 24 horas
                // Cobrar por horas completas
                const horas = Math.ceil(minutos / 60);
                return Math.ceil(horas * valorHora);
            } else {
                // Más de 24 horas - cobrar por días
                const dias = Math.ceil(minutos / 1440);
                return Math.ceil(dias * valorDia);
            }
        }

        // Función para seleccionar un vehículo
        function seleccionarVehiculo(idMovimiento, placa, tipo, color, modelo, minutos, montoEstimado) {
            document.getElementById('salIdMovimiento').value = idMovimiento;
            document.getElementById('salVehiculoInfo').value = `${placa} - ${tipo} ${color} ${modelo}`;
            
            // Mostrar información del monto a pagar
            const tiempoTexto = calcularTiempoTranscurrido(minutos);
            document.getElementById('montoAPagar').innerHTML = `
                <div class="alert alert-info">
                    <h6 class="mb-2"><i class="fas fa-calculator me-2"></i>Resumen de Cobro</h6>
                    <div class="row">
                        <div class="col-6">
                            <strong>Tiempo estacionado:</strong><br>
                            <span class="text-primary">${tiempoTexto}</span>
                        </div>
                        <div class="col-6">
                            <strong>Monto a cobrar:</strong><br>
                            <span class="text-success fs-5 fw-bold">$${montoEstimado.toLocaleString('es-AR')}</span>
                        </div>
                    </div>
                </div>
            `;
            
            // Ocultar lista y mostrar formulario
            document.getElementById('vehiculosEstacionados').classList.add('d-none');
            document.getElementById('formSalidaContainer').classList.remove('d-none');
        }

        // Función para cancelar selección
        function cancelarSeleccion() {
            document.getElementById('vehiculosEstacionados').classList.remove('d-none');
            document.getElementById('formSalidaContainer').classList.add('d-none');
            document.getElementById('salIdMovimiento').value = '';
            document.getElementById('salVehiculoInfo').value = '';
            document.getElementById('montoAPagar').innerHTML = '';
        }

        // Función para volver al dashboard
        function volverAlDashboard() {
            window.location.href = 'dashboard.html';
        }

        // Función para mostrar modal de salida exitosa
        function mostrarSalidaExitosa(datosFactura) {
            const resumenDiv = document.getElementById('resumenSalida');
            const tiempoTexto = calcularTiempoTranscurrido(datosFactura.tiempoMinutos || 0);
            
            resumenDiv.innerHTML = `
                <div class="row text-start">
                    <div class="col-12 mb-3">
                        <h4 class="text-center text-success mb-3">
                            <strong>$${datosFactura.total.toLocaleString('es-AR')}</strong>
                        </h4>
                    </div>
                    <div class="col-6">
                        <strong>Vehículo:</strong><br>
                        <span class="text-muted">${datosFactura.placa}</span>
                    </div>
                    <div class="col-6">
                        <strong>Tipo:</strong><br>
                        <span class="text-muted">${datosFactura.tipo}</span>
                    </div>
                    <div class="col-6 mt-2">
                        <strong>Tiempo:</strong><br>
                        <span class="text-muted">${tiempoTexto}</span>
                    </div>
                    <div class="col-6 mt-2">
                        <strong>Salida:</strong><br>
                        <span class="text-muted">${formatArgentinaDate(datosFactura.fechaSalida)}</span>
                    </div>
                </div>
            `;
            
            // Mostrar el modal
            const modal = new bootstrap.Modal(document.getElementById('salidaExitosaModal'));
            modal.show();
        }

        // Asegurar que la configuración esté cargada antes de renderizar tickets
        async function ensureEmpresaConfig(){
            if (!empresaInfo) return;
            if (typeof empresaInfo.operacion_24h === 'undefined'){
                try{
                    const cr = await fetch('/api/empresa/config',{headers:{'Authorization':`Bearer ${token}`}});
                    const cj = await cr.json();
                    if (cr.ok && cj && cj.data){
                        empresaInfo.operacion_24h = cj.data.operacion_24h;
                        empresaInfo.horario_apertura = cj.data.horario_apertura;
                        empresaInfo.horario_cierre = cj.data.horario_cierre;
                    }
                }catch(e){}
            }
        }

        function fmtTime(t){
            if (!t) return '';
            const s = String(t);
            return s.length>=5 ? s.substring(0,5) : s;
        }

        // Ingreso
        document.getElementById('formIngreso').addEventListener('submit', async (e)=>{
            e.preventDefault();
            await ensureEmpresaConfig();
            const placa = document.getElementById('ingPlaca').value.trim().toUpperCase();
            const tipo = document.getElementById('ingTipo').value;
            console.log('Enviando ingreso:', {placa, tipo});
            const res = await fetch('/api/movimientos/ingreso',{method:'POST',headers:{'Content-Type':'application/json','Authorization':`Bearer ${token}`},body:JSON.stringify({placa,tipo})});
            const data = await res.json();
            console.log('Respuesta ingreso:', data);
            if(!res.ok){alert(data.message||'Error');return;}
            const b = data.data;
            ultimoIngreso = b;
            
            try {
                document.getElementById('compIngresoBody').innerHTML = renderComprobante('INGRESO', b, null, empresaInfo);
                document.getElementById('compIngreso').classList.remove('d-none');
            } catch (error) {
                console.error('Error renderizando comprobante:', error);
            }
            
            document.getElementById('formIngreso').reset();
            
            // Mostrar mensaje de éxito y redirigir
            if (confirm('¡Ingreso registrado exitosamente! ¿Desea ir al dashboard?')) {
                window.location.href = 'dashboard.html';
            } else {
                // Si el usuario cancela, recargar la lista de vehículos estacionados
                if (typeof cargarVehiculosEstacionados === 'function') {
                    cargarVehiculosEstacionados();
                }
            }
        });

        // Salida
        document.getElementById('formSalida').addEventListener('submit', async (e)=>{
            e.preventDefault();
            await ensureEmpresaConfig();
            
            const idMovimiento = document.getElementById('salIdMovimiento').value;
            const metodoPref = document.getElementById('salMetodo').value;
            
            if (!idMovimiento) {
                alert('Error: No se ha seleccionado un vehículo');
                return;
            }
            
            const res = await fetch('/api/movimientos/salida',{
                method:'POST',
                headers:{'Content-Type':'application/json','Authorization':`Bearer ${token}`},
                body:JSON.stringify({id_movimiento: idMovimiento})
            });
            
            const data = await res.json();
            if(!res.ok){
                alert(data.message||'Error');
                return;
            }
            
            const f = data.data;
            ultimaSalida = f;
            
            try {
                document.getElementById('compSalidaBody').innerHTML = renderComprobante('SALIDA', null, f, empresaInfo);
                document.getElementById('compSalida').classList.remove('d-none');
            } catch (error) {
                console.error('Error renderizando comprobante:', error);
            }
            
            // Ocultar formulario y mostrar lista actualizada
            cancelarSeleccion();
            cargarVehiculosEstacionados(); // Recargar lista
            
            // Calcular tiempo transcurrido para el modal
            const fechaEntrada = new Date(f.fechaEntrada);
            const fechaSalida = new Date(f.fechaSalida);
            const tiempoMinutos = Math.round((fechaSalida - fechaEntrada) / 60000);
            
            // Mostrar modal de salida exitosa
            mostrarSalidaExitosa({
                placa: f.placa,
                tipo: f.tipo,
                total: f.total,
                fechaSalida: f.fechaSalida,
                tiempoMinutos: tiempoMinutos
            });
        });

        // Botones de impresión dedicados con tamaños 58/80mm y QR
        document.getElementById('btnPrintIngreso58').addEventListener('click', ()=>{
            const qr = JSON.stringify({t:'ingreso', e:empresaInfo?.nit, m:ultimoIngreso?.movimientoId, p:ultimoIngreso?.placa, fe:ultimoIngreso?.fechaEntrada});
            imprimirHTML(document.getElementById('compIngresoBody').innerHTML, 'Comprobante de Ingreso', 58, qr);
        });
        document.getElementById('btnPrintIngreso80').addEventListener('click', ()=>{
            const qr = JSON.stringify({t:'ingreso', e:empresaInfo?.nit, m:ultimoIngreso?.movimientoId, p:ultimoIngreso?.placa, fe:ultimoIngreso?.fechaEntrada});
            imprimirHTML(document.getElementById('compIngresoBody').innerHTML, 'Comprobante de Ingreso', 80, qr);
        });
        document.getElementById('btnPrintSalida58').addEventListener('click', ()=>{
            const qr = JSON.stringify({t:'salida', e:empresaInfo?.nit, m:ultimaSalida?.movimientoId, p:ultimaSalida?.placa, fs:ultimaSalida?.fechaSalida, total:ultimaSalida?.total});
            imprimirHTML(document.getElementById('compSalidaBody').innerHTML, 'Factura de Salida', 58, qr);
        });
        document.getElementById('btnPrintSalida80').addEventListener('click', ()=>{
            const qr = JSON.stringify({t:'salida', e:empresaInfo?.nit, m:ultimaSalida?.movimientoId, p:ultimaSalida?.placa, fs:ultimaSalida?.fechaSalida, total:ultimaSalida?.total});
            imprimirHTML(document.getElementById('compSalidaBody').innerHTML, 'Factura de Salida', 80, qr);
        });

        // Render de comprobante/factura compacto tipo ticket
        function renderComprobante(tipo, ingreso, salida, empresa){
            const e = empresa || {};
            const header = `
                <div style="text-align:center">
                    ${e.logo_url ? `<img src="${e.logo_url}" alt="logo" style="max-height:60px">` : ''}
                    <div><strong>${e.nombre||'Empresa'}</strong></div>
                    <div>CUIL/CUIT: ${e.nit||''}</div>
                    <div>${e.direccion||''} ${e.telefono? ' - '+e.telefono:''}</div>
                    <div>Horario: <strong>${(empresa?.operacion_24h)?'24 horas':((fmtTime(empresa?.horario_apertura)||'')+' - '+(fmtTime(empresa?.horario_cierre)||''))}</strong></div>
                    <hr/>
                    <div><strong>${tipo}</strong></div>
                </div>`;

            // Pie de ticket con crédito y enlace/ícono de YouTube de Ciscode
            const ciscodeFooter = `
                <hr/>
                <div style="text-align:center;margin-top:6px">
                    <div>Desarrollado por <strong>Ciscode</strong></div>
                    <div>
                        <a href="https://ciscode.co" target="_blank" style="text-decoration:none;color:#000">ciscode.co</a>
                        &nbsp;|&nbsp;
                        <a href="https://www.youtube.com/@Ciscode" target="_blank" aria-label="YouTube Ciscode" style="display:inline-flex;align-items:center;gap:4px;text-decoration:none;color:#000">
                            <span>
                                <svg width="18" height="12" viewBox="0 0 24 17" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                                    <path d="M23.5 2.6a3 3 0 0 0-2.1-2.1C19.5 0 12 0 12 0s-7.5 0-9.4.5A3 3 0 0 0 .5 2.6 31 31 0 0 0 0 8.5a31 31 0 0 0 .5 5.9 3 3 0 0 0 2.1 2.1C4.5 17 12 17 12 17s7.5 0 9.4-.5a3 3 0 0 0 2.1-2.1 31 31 0 0 0 .5-5.9 31 31 0 0 0-.5-5.9z" fill="#FF0000"/>
                                    <path d="M9.75 12.25V4.75L15.5 8.5l-5.75 3.75z" fill="#fff"/>
                                </svg>
                            </span>
                            <span style="font-size:10px">YouTube</span>
                        </a>
                    </div>
                </div>`;

            if (tipo === 'INGRESO') {
                return header + `
                    <div>Movimiento: <strong>#${ingreso.movimientoId}</strong></div>
                    <div>Placa: <strong>${ingreso.placa}</strong></div>
                    <div>Tipo: <strong>${ingreso.tipo}</strong></div>
                    <div>Entrada: <strong>${new Date(ingreso.fechaEntrada).toLocaleString('es-CO')}</strong></div>
                    <div>Tarifa: <strong>${ingreso.tarifa.tipo_vehiculo}</strong></div>
                    <div>Valor/min: <strong>${formatCurrency(ingreso.tarifa.valor_minuto)}</strong></div>
                    <div>Valor/hora: <strong>${formatCurrency(ingreso.tarifa.valor_hora)}</strong></div>
                    <div>Valor/día: <strong>${formatCurrency(ingreso.tarifa.valor_dia_completo)}</strong></div>
                    <div>Atendido por: ${localStorage.getItem('userName')||''}</div>
                    <div>Fecha impresión: ${new Date().toLocaleString('es-CO')}</div>`;
            } else {
                const pagosHtml = (salida.pagosList && salida.pagosList.length)
                    ? `<div><strong>Pagos</strong></div>` + salida.pagosList.map(p=>`<div>${p.metodo_pago}: <strong>${formatCurrency(Number(p.monto||0))}</strong></div>`).join('')
                    : '';
                return header + `
                    <div>Movimiento: <strong>#${salida.movimientoId}</strong></div>
                    <div>Placa: <strong>${salida.placa}</strong></div>
                    <div>Tipo: <strong>${salida.tipo}</strong></div>
                    <div>Entrada: <strong>${new Date(salida.fechaEntrada).toLocaleString('es-CO')}</strong></div>
                    <div>Salida: <strong>${new Date(salida.fechaSalida).toLocaleString('es-CO')}</strong></div>
                    <div>Tiempo: <strong>${salida.detalleTiempo.dias}d ${salida.detalleTiempo.horas}h ${salida.detalleTiempo.minutos}m</strong></div>
                    <hr/>
                    <div>Total: <strong>${formatCurrency(salida.total)}</strong></div>
                    ${pagosHtml}
                    <div>Atendido por: ${localStorage.getItem('userName')||''}</div>
                    <div>Fecha impresión: ${new Date().toLocaleString('es-CO')}</div>`;
            }    
        }

        // Abrir ventana de impresión con solo el ticket
        function imprimirHTML(html, titulo, anchoMM, qrPayload){
            const width = anchoMM || 58; // 58 o 80
            const w = window.open('', '_blank', 'width=420,height=700');
            const payload = encodeURIComponent(JSON.stringify(qrPayload || {}));
            const doc = `<!DOCTYPE html><html><head><meta charset="utf-8" /><title>${titulo}</title>
                <style>
                    @page{ size: ${width}mm auto; margin: 3mm }
                    body{ width:${width}mm; font-family: Arial, sans-serif; font-size:11px; margin:0 }
                    .wrap{ padding:4mm }
                    hr{ border:none; border-top:1px dashed #999; margin:6px 0 }
                    img{ display:block; margin:0 auto 6px; max-width:100% }
                    .qr{ display:flex; justify-content:center; margin-top:6px }
                    .barcode{ display:flex; justify-content:center; margin-top:6px }
                </style>
            </head><body><div class="wrap">${html}<div class="qr"><div id="qrcode"></div></div></div>
            <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"><\/script>
            <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.6/dist/JsBarcode.all.min.js"><\/script>
            <script>(function(){
                var companyUrl = 'https://gh0tstudio.com/';
                try{
                    // Parse payload (JSON) sólo para código de barras (placa)
                    var raw = JSON.parse(decodeURIComponent('${payload}'));
                    var payload = (typeof raw === 'string') ? JSON.parse(raw) : raw;
                    // QR apunta al sitio de la empresa
                    new QRCode(document.getElementById('qrcode'), {text: companyUrl, width:96, height:96});
                    // Render barcode si existe elemento
                    var svg = document.getElementById('barcodeSvg');
                    if (svg) { JsBarcode(svg, (payload && (payload.p || payload.placa)) || '', {format:'code128', displayValue:false, height:40}); }
                }catch(e){
                    // Fallback mínimo: QR con URL aunque falle el payload
                    try { new QRCode(document.getElementById('qrcode'), {text: companyUrl, width:96, height:96}); } catch(_e){}
                }
                setTimeout(function(){ window.print(); window.close(); }, 400);
            })();<\/script>
            </body></html>`;
            w.document.write(doc);
            w.document.close();
            w.focus();
        }

        // Modal de pago avanzado
        function abrirModalPago(factura, metodoPorDefecto){
            const modalEl = document.getElementById('pagoModal');
            document.getElementById('pagoTotal').textContent = new Intl.NumberFormat('es-CO',{style:'currency',currency:'COP',minimumFractionDigits:0}).format(factura.total);
            const cont = document.getElementById('pagosContainer');
            cont.innerHTML = '';
            const btnConfirm = document.getElementById('btnConfirmPagos');
            const addRow = (metodo='efectivo', monto='') => {
                const row = document.createElement('div');
                row.className = 'd-flex gap-2';
                row.innerHTML = `
                    <select class="form-select form-select-sm metodo" style="max-width:140px">
                        <option value="efectivo" ${metodo==='efectivo'?'selected':''}>Efectivo</option>
                        <option value="tarjeta" ${metodo==='tarjeta'?'selected':''}>Tarjeta</option>
                        <option value="QR" ${metodo==='QR'?'selected':''}>QR</option>
                    </select>
                    <input type="number" class="form-control form-control-sm monto" min="0" step="0.01" placeholder="Monto" value="${monto}">
                    <button class="btn btn-outline-danger btn-sm btnDel">&times;</button>
                `;
                row.querySelector('.btnDel').addEventListener('click', ()=>{ row.remove(); calc();});
                row.querySelector('.monto').addEventListener('input', calc);
                cont.appendChild(row);
            };
            const calc = ()=>{
                const montos = Array.from(cont.querySelectorAll('.monto')).map(i=>Number(i.value||0));
                const sum = montos.reduce((a,b)=>a+b,0);
                document.getElementById('pagoSum').textContent = new Intl.NumberFormat('es-CO',{style:'currency',currency:'COP',minimumFractionDigits:0}).format(sum);
                const diff = sum - factura.total;
                const sign = diff>=0? 'Vuelto: ' : 'Falta: ';
                const diffEl = document.getElementById('pagoDiff');
                diffEl.textContent = sign + new Intl.NumberFormat('es-CO',{style:'currency',currency:'COP',minimumFractionDigits:0}).format(Math.abs(diff));
                diffEl.className = diff>=0 ? 'text-success' : 'text-danger';
                btnConfirm.disabled = (sum + 0.0001) < factura.total; // deshabilitar si no está totalmente pago
            };
            document.getElementById('btnAddPago').onclick = ()=>{ addRow('efectivo',''); };
            addRow(metodoPorDefecto || 'efectivo', factura.total);
            calc();
            const modal = new bootstrap.Modal(modalEl);
            modal.show();

            btnConfirm.onclick = async ()=>{
                const rows = Array.from(cont.querySelectorAll('.d-flex'));
                const pagos = rows.map(r=>({
                    metodo_pago: r.querySelector('.metodo').value,
                    monto: Number(r.querySelector('.monto').value||0)
                })).filter(p=>p.monto>0);
                const totalPagado = pagos.reduce((a,b)=>a + Number(b.monto||0), 0);
                if ((totalPagado + 0.0001) < factura.total) {
                    alert('Falta valor por pagar. Completa el pago para finalizar.');
                    return;
                }
                try{
                    const res = await fetch('/api/pagos/bulk',{
                        method:'POST',
                        headers:{'Content-Type':'application/json','Authorization':`Bearer ${token}`},
                        body: JSON.stringify({ id_movimiento: factura.movimientoId, pagos })
                    });
                    const j = await res.json();
                    if(!res.ok) throw new Error(j.message||'Error registrando pagos');
                    // Reimprimir ticket con detalle de pagos
                    const facturaConPagos = Object.assign({}, factura, { pagosList: pagos });
                    const htmlTicket = renderComprobante('SALIDA', null, facturaConPagos, empresaInfo);
                    imprimirHTML(htmlTicket, 'Factura de Salida', 80, { t:'salida', e:empresaInfo?.nit, m:factura.movimientoId, p:factura.placa, fs:factura.fechaSalida, total: factura.total });
                    // Persistir la información de pagos en la vista para futuras reimpresiones
                    ultimaSalida = facturaConPagos;
                    document.getElementById('compSalidaBody').innerHTML = htmlTicket;
                    modal.hide();
                }catch(err){
                    alert('Error: '+err.message);
                }
            };
        }
    </script>
</body>
</html>

